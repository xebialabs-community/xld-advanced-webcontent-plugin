<?xml version="1.0"?>
<!--
THIS CODE AND INFORMATION ARE PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS
FOR A PARTICULAR PURPOSE. THIS CODE AND INFORMATION ARE NOT SUPPORTED BY XEBIALABS.
-->
<!--
    Note: If you modify this file and automatic reloading is disabled in `planner.conf`, you must restart the XL Deploy server.
  -->
  <rules xmlns="http://www.xebialabs.com/xl-deploy/xl-rules">
    <!-- Add your <rule ...> and <disable-rule ...> elements here -->

    <!-- wwwx.LargePublishedWebContent -->
    <rule name="wwwx.LargePublishedWebContent.CREATE" scope="deployed">
      <conditions>
        <type>wwwx.LargePublishedWebContent</type>
        <operation>CREATE</operation>
      </conditions>
      <steps>
        <os-script>
          <description expression="true">"%s %s to %s" % (deployed.deployVerb, deployed.name, deployed.container.name)</description>
          <script>wwwx/create-large-published-web-content</script>
          <upload-artifacts>true</upload-artifacts>
          <order expression="true">deployed.createOrder</order>
          <freemarker-context>
            <deployedApplication expression="true">context.deployedApplication</deployedApplication>
          </freemarker-context>
        </os-script>
        <checkpoint/>
      </steps>
    </rule>

    <rule name="wwwx.LargePublishedWebContent.MODIFY" scope="deployed">
      <conditions>
        <type>wwwx.LargePublishedWebContent</type>
        <operation>MODIFY</operation>
      </conditions>
      <steps>
        <os-script>
          <description expression="true">"%s %s on %s" % (previousDeployed.destroyVerb, previousDeployed.name, previousDeployed.container.name)</description>
          <script>wwwx/destroy-large-published-web-content</script>
          <upload-artifacts>true</upload-artifacts>
          <order expression="true">previousDeployed.destroyOrder</order>
          <freemarker-context>
            <deployedApplication expression="true">context.deployedApplication</deployedApplication>
          </freemarker-context>
        </os-script>
        <checkpoint completed="DESTROY"/>
        <os-script>
          <description expression="true">"%s %s to %s" % (deployed.deployVerb, deployed.name, deployed.container.name)</description>
          <script>wwwx/create-large-published-web-content</script>
          <upload-artifacts>true</upload-artifacts>
          <order expression="true">deployed.createOrder</order>
          <freemarker-context>
            <deployedApplication expression="true">context.deployedApplication</deployedApplication>
          </freemarker-context>
        </os-script>
        <checkpoint completed="CREATE"/>
      </steps>
    </rule>

    <rule name="wwwx.LargePublishedWebContent.DESTROY" scope="deployed">
      <conditions>
        <type>wwwx.LargePublishedWebContent</type>
        <operation>DESTROY</operation>
      </conditions>
      <steps>
        <os-script>
          <description expression="true">"%s %s on %s" % (previousDeployed.destroyVerb, previousDeployed.name, previousDeployed.container.name)</description>
          <script>wwwx/destroy-large-published-web-content</script>
          <upload-artifacts>true</upload-artifacts>
          <order expression="true">previousDeployed.destroyOrder</order>
          <freemarker-context>
            <deployedApplication expression="true">context.deployedApplication</deployedApplication>
          </freemarker-context>
        </os-script>
        <checkpoint/>
      </steps>
    </rule>

    <!-- wwwx.VersionedPublishedWebContent -->
    <rule name="wwwx.VersionedPublishedWebContent.CREATE_MODIFY" scope="deployed">
      <conditions>
        <type>wwwx.VersionedPublishedWebContent</type>
        <operation>CREATE</operation>
        <operation>MODIFY</operation>
      </conditions>
      <steps>
        <jython>
          <order>1</order>
            <description expression="true">"Determine target directory for %s" % (deployed.name)</description>
            <script>wwwx/determine-targetDirectory-for-versionedWebContent.py</script>
            <jython-context>
              <repositoryService expression="true">repositoryService</repositoryService>
              <logger expression="true">logger</logger>
              <version expression="true">context.deployedApplication.version.name</version>
            </jython-context>
        </jython>
        <os-script>
          <description expression="true">"Symlink %s to %s" % (deployed.name, deployed.nextSymlinkName)</description>
          <script>wwwx/link-webcontent</script>
          <freemarker-context>
            <linkTarget expression="true">deployed.nextSymlinkName</linkTarget>
          </freemarker-context>
          <upload-artifacts>false</upload-artifacts>
          <order expression="true">deployed.createOrder + 2</order>
        </os-script>
        <os-script>
          <description expression="true">"Symlink %s to %s" % (deployed.name, deployed.currentSymlinkName)</description>
          <script>wwwx/link-webcontent</script>
          <freemarker-context>
            <linkTarget expression="true">deployed.currentSymlinkName</linkTarget>
          </freemarker-context>
          <upload-artifacts>false</upload-artifacts>
          <order expression="true">90</order>
        </os-script>
      </steps>
    </rule>

    <rule name="wwwx.VersionedPublishedWebContent.invokePostProcessing.CREATE_MODIFY" scope="deployed">
      <conditions>
        <type>wwwx.VersionedPublishedWebContent</type>
        <operation>CREATE</operation>
        <operation>MODIFY</operation>
        <expression>deployed.postProcessCommand != ''</expression>
      </conditions>
      <steps>
        <os-script>
          <description expression="true">"Invoke post processing on %s" % deployed.name</description>
          <script>wwwx/invoke-post-processing</script>
          <upload-artifacts>false</upload-artifacts>
          <order expression="true">deployed.createOrder + 1</order>
        </os-script>
      </steps>
    </rule>

  </rules>
